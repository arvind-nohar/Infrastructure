{
  email arvind.nohar@seventrees.nl
  # Let the HTTP app use high ports so L4 can bind :443
  http_port 8080
  https_port 8443
}

layer4 {
  :443 {
    # Match Postgres connections by SNI
    @pg {
      tls
      tls.sni testing.seventrees.nl
    }
    route @pg {
      tls
      proxy {
        upstream pooler:5434
      }
    }

    # Default: terminate TLS then send HTTP to the HTTP app on :8080
    route {
      tls
      proxy {
        upstream 127.0.0.1:8080
      }
    }
  }
}

# HTTP app now listens on :8080 behind L4
seven.seventrees.nl {
  encode gzip
  reverse_proxy host.docker.internal:5000 {
    flush_interval -1
  }
  header {
    X-Content-Type-Options nosniff
    Referrer-Policy no-referrer-when-downgrade
    Access-Control-Allow-Origin "*"
    Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Access-Control-Allow-Headers "Content-Type, Authorization"
  }

  @embed {
    query embed=true
  }
  handle @embed {
    header Access-Control-Allow-Origin "*"
    header Access-Control-Allow-Methods "GET, POST, OPTIONS"
    header Access-Control-Allow-Headers "Content-Type, Authorization"
    header -X-Frame-Options
    reverse_proxy host.docker.internal:5000 {
      flush_interval -1
    }
  }

  @inject_script path /js/inject-chatbot.js
  handle @inject_script {
    header Access-Control-Allow-Origin "*"
    header Content-Type "application/javascript"
    header -X-Frame-Options
    reverse_proxy host.docker.internal:5000
  }
}
